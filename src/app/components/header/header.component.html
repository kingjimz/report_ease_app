<header
  class="header-container py-4 px-6 flex items-center justify-between sticky top-0"
  style="z-index: 9999"
>
  <!-- Logo & Title -->
  <div class="flex items-center">
    <!-- Short title for mobile -->
    <h1 class="ml-4 text-xl font-semibold header-text md:hidden">
      <span
        class="text-xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500"
        >FSTracker</span
      >
    </h1>
    <!-- Full title for desktop/tablet -->
    <h1 class="ml-4 text-xl font-semibold header-text hidden md:block">
      <span
        class="text-xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500"
        >Field Service Tracker</span
      >
    </h1>
  </div>

  <!-- Theme Toggle & Profile -->
  <div class="flex items-center gap-3">
    <!-- Notification Button -->
    <div class="relative" (clickOutside)="closeNotificationDropdown()">
      <button
        (click)="toggleNotificationDropdown($event)"
        class="relative flex items-center justify-center w-10 h-10 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors duration-200"
        title="Notifications"
      >
        <i class="bi bi-bell header-icon text-xl"></i>
        <span
          *ngIf="getNotificationCount() > 0"
          class="absolute top-0 right-0 flex items-center justify-center w-5 h-5 bg-red-500 text-white text-xs font-bold rounded-full transform translate-x-1 -translate-y-1"
        >
          {{ getNotificationCount() > 9 ? '9+' : getNotificationCount() }}
        </span>
      </button>

      <!-- Notification Dropdown -->
      <div
        *ngIf="notificationDropdownOpen"
        class="fixed lg:absolute left-0 right-0 lg:left-auto lg:right-0 top-16 lg:top-auto lg:mt-1 bottom-0 lg:bottom-auto w-full lg:w-80 xl:w-96 h-[calc(100vh-4rem)] lg:h-auto bg-white dark:bg-gray-800 shadow-xl border border-gray-200 dark:border-gray-700 z-50 lg:max-h-[500px] overflow-hidden flex flex-col"
        (click)="$event.stopPropagation()"
      >
        <!-- Notification Header -->
        <div class="px-4 py-3 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
          <h3 class="text-lg font-bold text-gray-900 dark:text-white">Notifications</h3>
          <button
            (click)="closeNotificationDropdown()"
            class="flex items-center justify-center w-8 h-8 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
          >
            <i class="bi bi-x-lg text-gray-600 dark:text-gray-400 text-sm"></i>
          </button>
        </div>

        <!-- Notification Content -->
        <div class="overflow-y-auto flex-1 lg:max-h-[400px]">
          <div *ngIf="overdueStudies.length === 0 && !showReportReminder" class="px-4 py-8 text-center">
            <div class="flex items-center justify-center w-16 h-16 bg-gray-100 dark:bg-gray-700 rounded-full mx-auto mb-4">
              <i class="bi bi-bell-slash text-gray-400 text-2xl"></i>
            </div>
            <p class="text-sm text-gray-600 dark:text-gray-400">No notifications</p>
            <p class="text-xs text-gray-500 dark:text-gray-500 mt-1">You're all caught up!</p>
          </div>

          <!-- Report Submission Reminder -->
          <div *ngIf="showReportReminder">
            <div class="px-4 py-2 bg-blue-50 dark:bg-blue-900/20 border-b border-blue-200 dark:border-blue-800">
              <p class="text-xs font-semibold text-blue-800 dark:text-blue-300 uppercase tracking-wide">
                Report Reminder
              </p>
            </div>
            <div class="px-4 py-3 border-b border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors cursor-pointer"
                 (click)="navigateToReports()">
              <div class="flex items-start space-x-3">
                <div class="flex-shrink-0 w-10 h-10 bg-blue-100 dark:bg-blue-900/40 rounded-lg flex items-center justify-center">
                  <i class="bi bi-calendar-check text-blue-600 dark:text-blue-400 text-lg"></i>
                </div>
                <div class="flex-1 min-w-0">
                  <div class="flex items-start justify-between mb-1">
                    <p class="text-sm font-semibold text-gray-900 dark:text-white">
                      Submit Monthly Report
                    </p>
                    <span class="ml-2 px-2 py-0.5 bg-blue-100 dark:bg-blue-900/40 text-blue-700 dark:text-blue-400 text-xs font-bold rounded-full whitespace-nowrap">
                      Due Soon
                    </span>
                  </div>
                  <p class="text-xs text-gray-600 dark:text-gray-400 mb-1">
                    Don't forget to submit your {{ currentMonthName }} monthly report
                  </p>
                  <p class="text-xs text-gray-500 dark:text-gray-500">
                    Click to add your report
                  </p>
                </div>
              </div>
            </div>
          </div>

          <!-- Missed Studies Notifications -->
          <div *ngIf="overdueStudies.length > 0">
            <div class="px-4 py-2 bg-amber-50 dark:bg-amber-900/20 border-b border-amber-200 dark:border-amber-800">
              <p class="text-xs font-semibold text-amber-800 dark:text-amber-300 uppercase tracking-wide">
                Missed Studies
              </p>
            </div>
            <div *ngFor="let study of overdueStudies" class="px-4 py-3 border-b border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors cursor-pointer"
                 (click)="navigateToReports()">
              <div class="flex items-start space-x-3">
                <div class="flex-shrink-0 w-10 h-10 bg-amber-100 dark:bg-amber-900/40 rounded-lg flex items-center justify-center">
                  <i class="bi bi-exclamation-triangle-fill text-amber-600 dark:text-amber-400 text-lg"></i>
                </div>
                <div class="flex-1 min-w-0">
                  <div class="flex items-start justify-between mb-1">
                    <p class="text-sm font-semibold text-gray-900 dark:text-white truncate">
                      {{ study.bible_study }}
                    </p>
                    <span class="ml-2 px-2 py-0.5 bg-red-100 dark:bg-red-900/40 text-red-700 dark:text-red-400 text-xs font-bold rounded-full whitespace-nowrap">
                      {{ calculateDaysOverdue(study.schedule) }}d overdue
                    </span>
                  </div>
                  <p class="text-xs text-gray-600 dark:text-gray-400 mb-1">
                    Scheduled: {{ formatScheduleDate(study.schedule) }}
                  </p>
                  <p class="text-xs text-gray-500 dark:text-gray-500">
                    {{ study.address }}
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Configure Button -->
    <button
      (click)="openConfigureModal()"
      class="flex items-center justify-center w-10 h-10 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors duration-200"
      title="Configure"
    >
      <i class="bi bi-sliders header-icon text-xl"></i>
    </button>

    <!-- Profile Dropdown -->
    <div class="relative profile-dropdown-container" (click)="toggleDropdown()">
    <button class="flex items-center space-x-3 focus:outline-none">
      <i class="bi bi-person-circle header-icon text-2xl"></i>
      <span class="header-text font-medium hidden sm:block">{{
        userData?.email
      }}</span>
      <svg
        class="w-4 h-4 header-text"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M19 9l-7 7-7-7"
        ></path>
      </svg>
    </button>

    <!-- Dropdown Menu -->
    <div
      *ngIf="dropdownOpen"
      class="dropdown-menu absolute right-0 mt-2 w-48 border rounded-lg shadow-lg z-10"
    >
      <hr />
      <button
        (click)="signOut()"
        class="w-full text-left px-4 py-2 text-red-600 hover-effect"
      >
        Sign Out
      </button>
    </div>
  </div>
  </div>
</header>

<!-- Configure Modal -->
<div
  *ngIf="showConfigureModal"
  class="fixed inset-0 z-[10000] flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm p-4"
  (click)="closeConfigureModal()"
>
  <div
    class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md mx-auto relative flex flex-col max-h-[90vh]"
    (click)="$event.stopPropagation()"
  >
    <!-- Modal Header -->
    <div class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700 flex-shrink-0">
      <div class="flex items-center space-x-2">
        <div class="flex items-center justify-center w-10 h-10 bg-blue-100 dark:bg-blue-900/40 rounded-lg">
          <i class="bi bi-sliders text-blue-600 dark:text-blue-400 text-lg"></i>
        </div>
        <div>
          <h2 class="text-lg font-bold text-gray-900 dark:text-white">Configure</h2>
          <p class="text-xs text-gray-600 dark:text-gray-400">Customize your dashboard</p>
        </div>
      </div>
      <button
        (click)="closeConfigureModal()"
        class="flex items-center justify-center w-8 h-8 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
        aria-label="Close"
      >
        <i class="bi bi-x-lg text-gray-600 dark:text-gray-400 text-lg"></i>
      </button>
    </div>

    <!-- Scrollable Content -->
    <div class="overflow-y-auto flex-1 px-4 py-4">
      <!-- Success Message -->
      <div
        *ngIf="showSuccessMessage"
        class="mb-3 p-3 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg flex items-center space-x-2 animate-in"
      >
        <i class="bi bi-check-circle text-green-600 dark:text-green-400 text-base"></i>
        <span class="text-xs text-green-800 dark:text-green-200 font-medium">{{ successMessage }}</span>
      </div>

      <!-- Component Toggles -->
      <div class="space-y-3">
        <!-- Theme Toggle -->
        <div class="p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
          <div class="flex items-start justify-between">
            <div class="flex-1 pr-3">
              <div class="flex items-center space-x-2 mb-1">
                <i class="bi bi-palette text-purple-600 dark:text-purple-400 text-base"></i>
                <h3 class="text-sm font-semibold text-gray-900 dark:text-white">Theme</h3>
              </div>
              <p class="text-xs text-gray-600 dark:text-gray-400 leading-relaxed">
                Switch between light and dark mode
              </p>
            </div>
            <div class="flex items-center flex-shrink-0">
              <label class="relative inline-flex items-center cursor-pointer">
                <input
                  type="checkbox"
                  [checked]="isDarkMode"
                  (change)="toggleTheme()"
                  class="sr-only peer"
                />
                <div class="w-11 h-6 bg-gray-300 dark:bg-gray-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-300 dark:peer-focus:ring-purple-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-gradient-to-r peer-checked:from-purple-600 peer-checked:to-indigo-600"></div>
              </label>
            </div>
          </div>
        </div>

        <!-- Notification Toggle -->
        <div class="p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
          <div class="flex items-start justify-between">
            <div class="flex-1 pr-3">
              <div class="flex items-center space-x-2 mb-1">
                <i class="bi bi-bell text-indigo-600 dark:text-indigo-400 text-base"></i>
                <h3 class="text-sm font-semibold text-gray-900 dark:text-white">Notifications</h3>
              </div>
              <p class="text-xs text-gray-600 dark:text-gray-400 leading-relaxed">
                <span *ngIf="notificationsEnabled && notificationPermission === 'granted'">
                  Daily reminders and report alerts enabled
                </span>
                <span *ngIf="!notificationsEnabled && notificationPermission === 'granted'">
                  Enable to receive daily reminders
                </span>
                <span *ngIf="notificationPermission === 'default'">
                  Click to enable notifications
                </span>
                <span *ngIf="notificationPermission === 'denied'" class="text-red-600 dark:text-red-400">
                  Blocked in browser settings
                </span>
              </p>
            </div>
            <div class="flex items-center flex-shrink-0">
              <label class="relative inline-flex items-center cursor-pointer">
                <input
                  type="checkbox"
                  [checked]="notificationsEnabled"
                  [disabled]="isRequestingPermission || notificationPermission === 'denied'"
                  (change)="toggleNotifications()"
                  class="sr-only peer"
                />
                <div class="w-11 h-6 bg-gray-300 dark:bg-gray-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 dark:peer-focus:ring-indigo-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-gradient-to-r peer-checked:from-indigo-600 peer-checked:to-purple-600"></div>
              </label>
              <span class="ml-1.5 text-xs text-gray-500 dark:text-gray-400" *ngIf="isRequestingPermission">
                ...
              </span>
            </div>
          </div>
        </div>

        <!-- Pioneer Status Toggle -->
        <div class="p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
          <div class="flex items-start justify-between">
            <div class="flex-1 pr-3">
              <div class="flex items-center space-x-2 mb-1">
                <i class="bi bi-trophy text-blue-600 dark:text-blue-400 text-base"></i>
                <h3 class="text-sm font-semibold text-gray-900 dark:text-white">600-Hour Goal</h3>
              </div>
              <p class="text-xs text-gray-600 dark:text-gray-400 leading-relaxed">
                Track your annual service year goal (Sep - Aug)
              </p>
            </div>
            <div class="flex items-center flex-shrink-0">
              <label class="relative inline-flex items-center cursor-pointer">
                <input
                  type="checkbox"
                  [(ngModel)]="isPioneer"
                  (change)="togglePioneerStatus()"
                  class="sr-only peer"
                />
                <div class="w-11 h-6 bg-gray-300 dark:bg-gray-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
              </label>
            </div>
          </div>
        </div>

        <!-- App Updates -->
        <div class="p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
          <div class="flex items-start justify-between">
            <div class="flex-1 pr-3">
              <div class="flex items-center space-x-2 mb-1">
                <i class="bi bi-arrow-clockwise text-green-600 dark:text-green-400 text-base"></i>
                <h3 class="text-sm font-semibold text-gray-900 dark:text-white">Software Update</h3>
              </div>
              <p class="text-xs text-gray-600 dark:text-gray-400 leading-relaxed">
                <span *ngIf="!isUpdateEnabled">
                  Updates not available on this device
                </span>
                <span *ngIf="isUpdateEnabled && updateAvailable">
                  New version available! Click to install.
                </span>
                <span *ngIf="isUpdateEnabled && !updateAvailable">
                  Check for the latest features and improvements (works on iOS & Android)
                </span>
              </p>
            </div>
            <div class="flex items-center flex-shrink-0">
              <button
                (click)="checkForUpdates()"
                [disabled]="isCheckingUpdate || !isUpdateEnabled"
                class="px-3 py-1.5 text-xs font-semibold rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                [class.bg-green-600]="updateAvailable && !isCheckingUpdate"
                [class.hover:bg-green-700]="updateAvailable && !isCheckingUpdate"
                [class.text-white]="updateAvailable && !isCheckingUpdate"
                [class.bg-gray-200]="!updateAvailable && !isCheckingUpdate"
                [class.dark:bg-gray-600]="!updateAvailable && !isCheckingUpdate"
                [class.text-gray-700]="!updateAvailable && !isCheckingUpdate"
                [class.dark:text-gray-300]="!updateAvailable && !isCheckingUpdate"
                [class.hover:bg-gray-300]="!updateAvailable && !isCheckingUpdate"
                [class.dark:hover:bg-gray-500]="!updateAvailable && !isCheckingUpdate"
                title="Check for updates"
              >
                <span *ngIf="isCheckingUpdate" class="flex items-center">
                  <span class="animate-spin rounded-full h-3 w-3 border-t-2 border-current mr-1.5"></span>
                  Checking...
                </span>
                <span *ngIf="!isCheckingUpdate && updateAvailable">Install Update</span>
                <span *ngIf="!isCheckingUpdate && !updateAvailable">Check</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Footer -->
    <div class="p-4 border-t border-gray-200 dark:border-gray-700 flex-shrink-0">
      <button
        (click)="closeConfigureModal()"
        class="w-full px-4 py-2.5 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition-colors shadow-sm text-sm"
      >
        Done
      </button>
    </div>
  </div>
</div>
