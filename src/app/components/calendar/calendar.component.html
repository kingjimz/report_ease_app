<!-- Loader -->
<div *ngIf="isLoading">
  <app-loader [loadingMessage]="'Loading your reports...'"></app-loader>
</div>
<div *ngIf="!isLoading" class="container mx-auto px-2 py-2 mt-2 sm:mt-2">
  <h1 class="text-2xl font-bold" style="color: var(--text-primary);">Calendar</h1>
  <p class="mb-3" style="color: var(--text-secondary);">View and manage your reports and activities.</p>
  <div class="calendar-card shadow-md rounded-lg p-2">
    <div class="flex justify-between items-center mb-4">
      <button
        (click)="previousMonth()"
        class="nav-button px-4 py-2 rounded"
      >
        ◀
      </button>
      <h2 class="text-xl font-semibold" style="color: var(--text-primary);">{{ getMonthYearDisplay() }}</h2>
      <button
        (click)="nextMonth()"
        class="nav-button px-4 py-2 rounded"
      >
        ▶
      </button>
    </div>

    <div class="flex space-x-2 view-toggle-container p-1 rounded-lg">
      <button
        (click)="viewMode = 'month'"
        [class.bg-green-600]="viewMode === 'month'"
        [class.text-white]="viewMode === 'month'"
        class="view-toggle-button px-4 py-2 rounded-lg transition-colors duration-200"
      >
        <i class="bi bi-calendar me-1"></i> Month
      </button>
      <button
        (click)="viewMode = 'week'"
        [class.bg-green-600]="viewMode === 'week'"
        [class.text-white]="viewMode === 'week'"
        class="view-toggle-button px-4 py-2 rounded-lg transition-colors duration-200"
      >
        <i class="bi bi-calendar-week me-1"></i> Week
      </button>
    </div>

    <!-- Month View -->
    <div
      *ngIf="viewMode === 'month'"
      class="calendar-container rounded-lg shadow-md overflow-hidden mt-4"
    >
      <!-- Days of week header -->
      <div class="grid grid-cols-7 calendar-header">
        <div
          *ngFor="let day of daysOfWeek"
          class="calendar-day-header p-3 text-center font-medium border-r last:border-r-0"
        >
          {{ day }}
        </div>
      </div>

      <!-- Calendar grid -->
      <div class="grid grid-cols-7">
        <div
          *ngFor="let day of calendarDays; trackBy: trackByDay"
          class="calendar-day-cell min-h-[100px] border-r border-b last:border-r-0 p-2 cursor-pointer transition-colors relative"
          [class.not-current-month]="!day.isCurrentMonth"
          [class.today]="day.isToday"
          (click)="onDayClick(day)"
        >
          <div class="flex justify-between items-start mb-1">
            <span
              class="text-sm font-medium day-number"
              [class.not-current-month-text]="!day.isCurrentMonth"
              [class.today-text]="day.isToday"
            >
              {{ day.date.getDate() }}
            </span>

            <!-- Event indicator dot -->
            <div
              *ngIf="hasEvent(day.date)"
              class="w-2 h-2 bg-green-500 rounded-full"
            ></div>
          </div>

          <!-- Hours display -->
          <div
            *ngIf="hasEvent(day.date)"
            class="event-hours text-xs text-green-700 font-medium bg-green-100 rounded px-1 py-0.5 inline-block"
          >
            {{ getEventHours(day.date) }}
          </div>
        </div>
      </div>
    </div>

    <!-- Week View -->
    <div
      *ngIf="viewMode === 'week'"
      class="calendar-container rounded-lg shadow-md overflow-hidden mt-4"
    >
      <div class="grid grid-cols-7 calendar-header">
        <div
          *ngFor="let day of weekDays"
          class="calendar-day-header p-3 text-center font-medium border-r last:border-r-0"
        >
          <div>{{ day | date: "EEE" }}</div>
          <div class="text-lg" [class.text-blue-600]="isToday(day)">
            {{ day | date: "d" }}
          </div>
        </div>
      </div>

      <div class="grid grid-cols-7">
        <div
          *ngFor="let day of weekDays"
          class="calendar-day-cell min-h-[200px] border-r border-b last:border-r-0 cursor-pointer p-2 relative"
          (click)="
            onDayClick({
              date: day,
              isCurrentMonth: true,
              isToday: isToday(day),
            })
          "
        >
          <!-- Hours display for week view -->
          <div
            *ngIf="hasEvent(day)"
            class="event-hours text-xs text-green-700 font-medium bg-green-100 rounded px-2 py-1 inline-block"
          >
            {{ getEventHours(day) }}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!--Modal-->
<div
  *ngIf="selectedDate"
  class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm z-[10000]"
>
  <div
    class="modal-content p-4 rounded shadow-lg sm:w-full md:w-1/2 lg:w-1/3 xl:w-1/3 max-h-full overflow-auto"
  >
    <h3 class="text-lg font-medium mb-2 modal-title">
      Report for {{ selectedDate | date: "fullDate" }}
    </h3>
    <form>
      <div class="mb-4">
        <label class="block text-sm font-medium form-label">Hours</label>
        <div class="flex items-center space-x-6">
          <!-- Hours -->
          <div class="flex items-center space-x-2">
            <button
              type="button"
              class="form-button px-2 py-1 rounded text-lg"
              (click)="hours = Math.max(0, (+hours || 0) - 1)"
            >
              &#9664;
            </button>
            <input
              type="text"
              id="hours"
              name="hours"
              [(ngModel)]="hours"
              class="form-input w-12 text-center px-2 py-1 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-xs"
              readonly
            />
            <button
              type="button"
              class="form-button px-2 py-1 rounded text-lg"
              (click)="hours = (+hours || 0) + 1"
            >
              &#9654;
            </button>
            <span class="ml-1 form-text">hrs</span>
          </div>
          <!-- Minutes -->
          <div class="flex items-center space-x-2">
            <button
              type="button"
              class="form-button px-2 py-1 rounded text-lg"
              (click)="minutes = Math.max(0, (+minutes || 0) - 5)"
            >
              &#9664;
            </button>
            <input
              type="text"
              id="minutes"
              name="minutes"
              [(ngModel)]="minutes"
              class="form-input w-12 text-center px-2 py-1 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-xs"
              readonly
            />
            <button
              type="button"
              class="form-button px-2 py-1 rounded text-lg"
              (click)="minutes = Math.min(55, (+minutes || 0) + 5)"
            >
              &#9654;
            </button>
            <span class="ml-1 form-text">min</span>
          </div>
        </div>
      </div>
      <div class="mb-4" *ngIf="hasExistingEvent; else noEvent">
        <label
          for="is_joined_ministry"
          class="block text-sm font-medium form-label"
          >Did you participate in the ministry today?</label
        >
        <input
          type="text"
          id="is_joined_ministry"
          name="is_joined_ministry"
          [(ngModel)]="joined_ministry"
          class="form-input mt-1 block w-full px-3 py-2 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
          readonly
        />
      </div>
      <ng-template #noEvent>
        <div class="mb-4">
          <label
            for="is_joined_ministry"
            class="block text-sm font-medium form-label"
            >Did you participate in the ministry today?</label
          >
          <select
            id="is_joined_ministry"
            name="is_joined_ministry"
            [(ngModel)]="joined_ministry"
            class="form-input mt-1 block w-full px-3 py-2 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
          >
            <option value="yes">Yes</option>
            <option value="no">No</option>
          </select>
        </div>
      </ng-template>

      <div class="mb-4">
        <label for="note" class="block text-sm font-medium form-label"
          >Notes <span>(Optional)</span></label
        >
        <textarea
          id="note"
          name="note"
          [(ngModel)]="note"
          rows="5"
          class="form-input mt-1 block w-full px-3 py-2 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
        >
        </textarea>
      </div>

      <div
        *ngIf="noChangeDetected"
        class="mb-4 p-2 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700"
      >
        <p class="text-sm">
          No modifications detected. The system will not commit any updates.
        </p>
      </div>
      <div
        *ngIf="!noChangeDetected"
        class="mb-4 p-2 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700"
      >
        <p class="text-sm">Warning: Please verify your input carefully.</p>
      </div>
    </form>

    <div class="flex flex-wrap gap-2">
      <ng-container *ngIf="hasExistingEvent; else noExistingEvent">
        <button
          class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-700 transition-colors"
          (click)="updateReport()"
          [disabled]="noChangeDetected"
          [ngClass]="{
            'opacity-50 cursor-not-allowed': noChangeDetected,
          }"
        >
          Update
        </button>
        <button
          class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-700 transition-colors"
          (click)="openDeleteConfirmModal()"
        >
          <i class="bi bi-trash me-1"></i>
          Delete
        </button>
      </ng-container>
      <ng-template #noExistingEvent>
        <button
          class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-700 transition-colors"
          (click)="saveReport()"
          [disabled]="(!hours && !minutes) || !joined_ministry"
          [ngClass]="{
            'opacity-50 cursor-not-allowed':
              (!hours && !minutes) || !joined_ministry,
          }"
        >
          Save
        </button>
      </ng-template>

      <button
        (click)="closeModal()"
        class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition-colors ml-auto"
      >
        Close
      </button>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div
  *ngIf="showDeleteConfirmModal"
  class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm z-[10000] p-4"
  (click)="closeDeleteConfirmModal()"
>
  <div
    class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-md w-full p-6 transform transition-all"
    (click)="$event.stopPropagation()"
  >
    <!-- Icon -->
    <div class="flex items-center justify-center w-16 h-16 mx-auto mb-4 bg-red-100 dark:bg-red-900/30 rounded-full">
      <i class="bi bi-exclamation-triangle-fill text-red-600 dark:text-red-400 text-3xl"></i>
    </div>

    <!-- Title -->
    <h3 class="text-xl font-bold text-gray-900 dark:text-white text-center mb-2">
      Delete Report?
    </h3>

    <!-- Message -->
    <p class="text-gray-600 dark:text-gray-400 text-center mb-6">
      Are you sure you want to delete the report for
      <span class="font-semibold text-gray-900 dark:text-white">
        {{ selectedDate | date: 'fullDate' }}
      </span>?
      <br />
      <span class="text-sm text-red-600 dark:text-red-400 mt-2 block">
        This action cannot be undone.
      </span>
    </p>

    <!-- Buttons -->
    <div class="flex gap-3">
      <button
        (click)="closeDeleteConfirmModal()"
        [disabled]="isDeleting"
        class="flex-1 px-4 py-2.5 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors font-medium disabled:opacity-50 disabled:cursor-not-allowed"
      >
        Cancel
      </button>
      <button
        (click)="confirmDeleteReport()"
        [disabled]="isDeleting"
        class="flex-1 px-4 py-2.5 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-medium disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center"
      >
        <span
          *ngIf="isDeleting"
          class="animate-spin rounded-full h-4 w-4 border-t-2 border-white inline-block mr-2"
        ></span>
        {{ isDeleting ? 'Deleting...' : 'Delete' }}
      </button>
    </div>
  </div>
</div>
