<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Field Service Tracker</title>
    <base href="/" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
    <meta name="app-version" content="1.0.0">
    
    <!-- iOS PWA Support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="FSTracker">
    <meta name="format-detection" content="telephone=no">
    
    <!-- Apple Touch Icons for iOS -->
    <link rel="apple-touch-icon" href="assets/icons/fst-icon-192x192.png">
    <link rel="apple-touch-icon" sizes="72x72" href="assets/icons/fst-icon-192x192.png">
    <link rel="apple-touch-icon" sizes="96x96" href="assets/icons/fst-icon-192x192.png">
    <link rel="apple-touch-icon" sizes="128x128" href="assets/icons/fst-icon-192x192.png">
    <link rel="apple-touch-icon" sizes="144x144" href="assets/icons/fst-icon-192x192.png">
    <link rel="apple-touch-icon" sizes="152x152" href="assets/icons/fst-icon-192x192.png">
    <link rel="apple-touch-icon" sizes="192x192" href="assets/icons/fst-icon-192x192.png">
    <link rel="apple-touch-icon" sizes="384x384" href="assets/icons/fst-icon-512x512.png">
    <link rel="apple-touch-icon" sizes="512x512" href="assets/icons/fst-icon-512x512.png">
    
    <!-- Standard favicon and manifest -->
    <link rel="icon" type="image/png" sizes="192x192" href="assets/icons/fst-icon-192x192.png" />
    <link rel="icon" type="image/png" sizes="512x512" href="assets/icons/fst-icon-512x512.png" />
    <link rel="shortcut icon" type="image/png" href="assets/icons/fst-icon-192x192.png" />
    <link rel="manifest" href="manifest.webmanifest" />
    
    <!-- Theme color for mobile browsers -->
    <meta name="theme-color" content="#1976d2" />
    <meta name="msapplication-TileColor" content="#1976d2" />
    
    <!-- Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <app-root>
      <div style="display: flex; align-items: center; justify-content: center; min-height: 100vh; background-color: var(--bg-primary, #ffffff); color: var(--text-primary, #111827); font-family: 'Poppins', sans-serif;">
        <div style="text-align: center; padding: 20px;">
          <div style="font-size: 18px; margin-bottom: 10px;">Loading...</div>
          <div style="font-size: 14px; color: var(--text-secondary, #6b7280);">Please wait while the app initializes</div>
        </div>
      </div>
    </app-root>
    <noscript
      >Please enable JavaScript to continue using this application.</noscript
    >
    <script>
      // iOS compatibility: Ensure app loads even if service worker fails
      // This prevents iOS Safari from getting stuck during service worker registration
      (function() {
        var isIOS = navigator.userAgent.match(/iPhone|iPad|iPod/i);
        
        if (isIOS) {
          // Unregister any existing service workers that might be causing blank screen issues
          if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(function(registrations) {
              for (var i = 0; i < registrations.length; i++) {
                registrations[i].unregister().catch(function(err) {
                  console.warn('Failed to unregister service worker on iOS:', err);
                });
              }
            }).catch(function(err) {
              console.warn('Error getting service worker registrations on iOS:', err);
            });
            
            // Handle service worker errors gracefully on iOS
            navigator.serviceWorker.addEventListener('error', function(event) {
              console.warn('Service worker error on iOS:', event);
              // Don't block app loading
            });
          }
          
          // Check if Angular has bootstrapped after page load
          window.addEventListener('load', function() {
            var checkInterval = setInterval(function() {
              var appRoot = document.querySelector('app-root');
              if (appRoot) {
                // Check if Angular has rendered content (not just the loading div)
                var hasContent = appRoot.children.length > 0 && 
                                 appRoot.innerHTML.trim().length > 200; // More than just loading message
                
                if (hasContent) {
                  clearInterval(checkInterval);
                  console.log('App loaded successfully on iOS');
                } else {
                  // After 10 seconds, if still no content, try to reload
                  setTimeout(function() {
                    if (!hasContent) {
                      console.warn('App may be stuck on iOS, attempting recovery...');
                      // Try to force a re-render
                      window.dispatchEvent(new Event('resize'));
                      // If still stuck after 5 more seconds, reload
                      setTimeout(function() {
                        var stillStuck = document.querySelector('app-root') && 
                                       document.querySelector('app-root').innerHTML.trim().length < 200;
                        if (stillStuck) {
                          console.warn('App still stuck, reloading page...');
                          window.location.reload();
                        }
                      }, 5000);
                    }
                  }, 10000);
                }
              }
            }, 1000);
            
            // Clear interval after 30 seconds max
            setTimeout(function() {
              clearInterval(checkInterval);
            }, 30000);
          });
          
          // Prevent iOS from caching the page in a broken state
          window.addEventListener('pageshow', function(event) {
            if (event.persisted) {
              // Page was loaded from cache, force a reload to prevent blank screen
              console.log('Page loaded from cache on iOS, reloading...');
              window.location.reload();
            }
          });
          
          // Catch any unhandled errors that might prevent Angular from bootstrapping
          window.addEventListener('error', function(event) {
            console.error('JavaScript error on iOS:', event.error);
            // Don't prevent default, let Angular handle it if possible
          });
        }
      })();
    </script>
  </body>
</html>
